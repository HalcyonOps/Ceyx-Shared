name: Sync Repository Files

on:
  push:
    paths:
      - 'resources/**'
  workflow_dispatch:

jobs:
  sync-files:
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          path: source-repo

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate GitHub App Token (using Bash)
        id: generate-token
        env:
          APP_ID: ${{ vars.CEYX_SHARED_RESOURCES_SYNC_APP_ID }}
          PRIVATE_KEY: ${{ secrets.CEYX_SHARED_RESOURCES_SYNC_APP_PRIVATE_KEY }}
        run: |
          echo "Generating JWT..."
          private_key="${PRIVATE_KEY//\\n/$'\n'}"
          header='{"alg":"RS256","typ":"JWT"}'
          now=$(date +%s)
          payload=$(jq -n --arg iat "$((now - 60))" --arg exp "$((now + 600))" --arg iss "$APP_ID" '{iat: $iat|tonumber, exp: $exp|tonumber, iss: $iss}')
          
          header_base64=$(echo -n "$header" | openssl base64 -e | tr -d '=' | tr '/+' '_-' | tr -d '\n')
          payload_base64=$(echo -n "$payload" | openssl base64 -e | tr -d '=' | tr '/+' '_-' | tr -d '\n')
          unsigned_token="$header_base64.$payload_base64"
          signature=$(echo -n "$unsigned_token" | openssl dgst -sha256 -sign <(echo -e "$private_key") | openssl base64 -e | tr -d '=' | tr '/+' '_-' | tr -d '\n')
          jwt="$unsigned_token.$signature"
          echo "::set-output name=token::$jwt"

      - name: Get Installation Token
        id: get-installation-token
        env:
          JWT_TOKEN: ${{ steps.generate-token.outputs.token }}
          INSTALLATION_ID: ${{ vars.CEYX_SHARED_RESOURCES_SYNC_APP_INSTALLATION_ID }}
        run: |
          echo "Retrieving installation token..."
          token_response=$(curl -s -X POST \
            -H "Authorization: Bearer $JWT_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/app/installations/$INSTALLATION_ID/access_tokens")

          installation_token=$(echo "$token_response" | jq -r .token)
          echo "::set-output name=installation_token::$installation_token"

      - name: Test Installation Token Access
        env:
          INSTALLATION_TOKEN: ${{ steps.get-installation-token.outputs.installation_token }}
        run: |
          curl -s -H "Authorization: token $INSTALLATION_TOKEN" \
          -H "Accept: application/vnd.github+json" \
          "https://api.github.com/repos/HalcyonOps/Ceyx-AWS-EC2" || echo "Token access failed"

      - name: Sync files to target repositories
        uses: actions/github-script@v7
        env:
          INSTALLATION_TOKEN: ${{ steps.get-installation-token.outputs.installation_token }}
          TARGET_REPOS: ${{ vars.CEYX_SHARED_RESOURCES_SYNC_APP_TARGET_REPOS }}
        with:
          script: |
            const fs = require('fs').promises;
            const path = require('path');

            async function listFiles(dir) {
              const files = [];
              async function traverse(currentPath, relativePath = '') {
                const entries = await fs.readdir(currentPath, { withFileTypes: true });
                for (const entry of entries) {
                  const fullPath = path.join(currentPath, entry.name);
                  const relativeFinalPath = path.join(relativePath, entry.name);
                  if (entry.isDirectory()) {
                    await traverse(fullPath, relativeFinalPath);
                  } else if (!relativeFinalPath.endsWith('Zone.Identifier')) { // Skip metadata files
                    files.push({ fullPath, relativePath: relativeFinalPath });
                  }
                }
              }
              await traverse(dir);
              return files;
            }

            const targetRepos = process.env.TARGET_REPOS.split('\n').map(repo => {
              const match = repo.trim().match(/github\.com\/([^/]+\/[^.]+)(?:\.git)?/);
              return match ? match[1] : null;
            }).filter(Boolean);

            for (const repo of targetRepos) {
              const [owner, repoName] = repo.split('/');
              console.log(`Processing target repository: ${repo}`);
              
              try {
                const { data: repoData } = await github.rest.repos.get({
                  owner,
                  repo: repoName,
                  headers: { authorization: `token ${process.env.INSTALLATION_TOKEN}` }
                });
                
                const defaultBranch = repoData.default_branch;
                const sourceFiles = await listFiles('source-repo/resources');

                for (const file of sourceFiles) {
                  try {
                    const content = await fs.readFile(file.fullPath, 'base64');
                    let sha;

                    try {
                      const { data: existingFile } = await github.rest.repos.getContent({
                        owner,
                        repo: repoName,
                        path: file.relativePath,
                        headers: { authorization: `token ${process.env.INSTALLATION_TOKEN}` }
                      });
                      sha = existingFile.sha;
                    } catch (error) {
                      if (error.status !== 404) throw error; // 404 means file doesn't exist yet
                    }

                    await github.rest.repos.createOrUpdateFileContents({
                      owner,
                      repo: repoName,
                      path: file.relativePath,
                      message: `Sync file: ${file.relativePath}`,
                      content: content,
                      sha,
                      branch: defaultBranch,
                      headers: { authorization: `token ${process.env.INSTALLATION_TOKEN}` }
                    });

                    console.log(`Successfully synced ${file.relativePath} to ${repo}`);
                  } catch (error) {
                    console.error(`Failed to sync ${file.relativePath} to ${repo}: ${error.message}`);
                  }
                }
              } catch (error) {
                console.error(`Failed to process repository ${repo}: ${error.message}`);
              }
            }
