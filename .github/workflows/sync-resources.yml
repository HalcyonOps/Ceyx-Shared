name: Sync Repository Files

on:
  # Trigger on changes to resources directory
  push:
    paths:
      - 'resources/**'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  sync-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          path: source-repo

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install jsonwebtoken

      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/github-script@v7
        env:
          APP_ID: ${{ vars.CEYX_SHARED_RESOURCES_SYNC_APP_ID }}
          PRIVATE_KEY: ${{ secrets.CEYX_SHARED_RESOURCES_SYNC_APP_PRIVATE_KEY }}
        with:
          script: |
            const jwt = require('jsonwebtoken');
            try {
              // Clean up private key - replace literal '\n' with actual line breaks
              const privateKey = process.env.PRIVATE_KEY
                .replace(/\\n/g, '\n')
                .trim();
              
              // Verify private key format
              if (!privateKey.startsWith('-----BEGIN RSA PRIVATE KEY-----')) {
                throw new Error('Invalid private key format');
              }

              const payload = {
                iat: Math.floor(Date.now() / 1000) - 60,
                exp: Math.floor(Date.now() / 1000) + (10 * 60),
                iss: process.env.APP_ID
              };

              const token = jwt.sign(payload, privateKey, { algorithm: 'RS256' });
              
              // Verify the token can be decoded
              jwt.verify(token, privateKey, { algorithms: ['RS256'] });
              
              console.log('JWT generation and verification successful');
              return token;
            } catch (error) {
              core.setFailed(`JWT Generation failed: ${error.message}`);
              throw error;
            }

      - name: Get Installation Token
        id: get-installation-token
        uses: actions/github-script@v7
        env:
          JWT_TOKEN: ${{ steps.generate-token.outputs.result }}
          INSTALLATION_ID: ${{ vars.CEYX_SHARED_RESOURCES_SYNC_APP_INSTALLATION_ID }}
        with:
          script: |
            try {
              const installationId = process.env.INSTALLATION_ID;
              
              const tokenResponse = await github.rest.apps.createInstallationAccessToken({
                installation_id: installationId,
                headers: {
                  authorization: `Bearer ${process.env.JWT_TOKEN}`,
                  accept: 'application/vnd.github.v3+json'
                }
              });

              return tokenResponse.data.token;
            } catch (error) {
              core.setFailed(`Failed to get installation token: ${error.message}`);
              throw error;
            }

      - name: Sync files to target repositories
        uses: actions/github-script@v7
        env:
          INSTALLATION_TOKEN: ${{ steps.get-installation-token.outputs.result }}
          TARGET_REPOS: ${{ vars.CEYX_SHARED_RESOURCES_SYNC_APP_TARGET_REPOS }}
        with:
          script: |
            const fs = require('fs').promises;
            const path = require('path');
            
            async function listFiles(dir) {
              const files = [];
              
              async function traverse(currentPath, relativePath = '') {
                const entries = await fs.readdir(currentPath, { withFileTypes: true });
                
                for (const entry of entries) {
                  const fullPath = path.join(currentPath, entry.name);
                  const relativeFinalPath = path.join(relativePath, entry.name);
                  
                  if (entry.isDirectory()) {
                    await traverse(fullPath, relativeFinalPath);
                  } else {
                    files.push({
                      fullPath,
                      relativePath: relativeFinalPath
                    });
                  }
                }
              }
              
              await traverse(dir);
              return files;
            }

            try {
              const targetRepos = process.env.TARGET_REPOS.split(',').map(repo => repo.trim());
              const sourceFiles = await listFiles('source-repo/resources');
              
              for (const repo of targetRepos) {
                console.log(`Processing target repository: ${repo}`);
                const [owner, repoName] = repo.split('/');
                
                // Get the default branch
                const { data: repoData } = await github.rest.repos.get({
                  owner,
                  repo: repoName,
                  headers: {
                    authorization: `token ${process.env.INSTALLATION_TOKEN}`
                  }
                });
                
                const defaultBranch = repoData.default_branch;

                for (const file of sourceFiles) {
                  try {
                    // Read file content
                    const content = await fs.readFile(file.fullPath, 'base64');
                    
                    // Try to get existing file (to get sha if it exists)
                    let sha;
                    try {
                      const { data: existingFile } = await github.rest.repos.getContent({
                        owner,
                        repo: repoName,
                        path: file.relativePath,
                        headers: {
                          authorization: `token ${process.env.INSTALLATION_TOKEN}`
                        }
                      });
                      sha = existingFile.sha;
                    } catch (error) {
                      // File doesn't exist yet, which is fine
                    }

                    // Create or update file
                    await github.rest.repos.createOrUpdateFileContents({
                      owner,
                      repo: repoName,
                      path: file.relativePath,
                      message: `Sync file: ${file.relativePath}`,
                      content: content.toString('base64'),
                      sha,
                      branch: defaultBranch,
                      headers: {
                        authorization: `token ${process.env.INSTALLATION_TOKEN}`
                      }
                    });
                    
                    console.log(`Successfully synced ${file.relativePath} to ${repo}`);
                  } catch (error) {
                    console.error(`Failed to sync ${file.relativePath} to ${repo}: ${error.message}`);
                    core.error(`Failed to sync ${file.relativePath} to ${repo}: ${error.message}`);
                    // Continue with next file instead of failing completely
                  }
                }
              }
            } catch (error) {
              core.setFailed(`Sync process failed: ${error.message}`);
              throw error;
            }
